// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                          String    @id @default(uuid())
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  pubkey                      String    @unique // nostr pubkey
  listings                    Listing[] @relation("SellerListings")
  won                         Listing[] @relation("WinnerListings")
  bids                        Bid[]
  receiveOnlyConnectionSecret String?   @unique
  contactInfo                 String?
}

model Listing {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  title                String
  description          String?
  imageUrl             String?
  seller               User      @relation("SellerListings", fields: [sellerId], references: [id])
  sellerId             String
  winner               User?     @relation("WinnerListings", fields: [winnerId], references: [id])
  winnerId             String?
  startingBid          Int
  minimumBidAbsolute   Int?
  minimumBidPercentage Int?
  startsAt             DateTime? // restrict when bidding can start, optional
  endedAt              DateTime? // once winning invoice is settled or when endsAt is hit
  endsAt               DateTime? // hard cut off, optional
  public               Boolean
  bids                 Bid[]
  pin                  String // shared with winner and seller once the auction ends
}

model Bid {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  bidder               User      @relation(fields: [bidderId], references: [id])
  bidderId             String
  listing              Listing   @relation(fields: [listingId], references: [id])
  listingId            String
  invoice              String    @unique
  preimage             String    @unique
  paymentHash          String    @unique
  settleDeadline       DateTime?
  settleDeadlineBlocks Int?
  amount               Int
  paid                 Boolean
  held                 Boolean
  settled              Boolean
}
